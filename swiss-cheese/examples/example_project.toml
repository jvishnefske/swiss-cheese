# Swiss Cheese Model - Software Design Document
# This TOML file defines verification layers, tasks, and dependencies
# for production Rust development.

[project]
name = "example-production-system"
version = "0.1.0"
language = "rust"
description = "Example project demonstrating Swiss Cheese verification model"

# Rust toolchain requirements
[project.toolchain]
rust = "1.75.0"
edition = "2021"

# Additional language support (optional)
[project.additional_languages]
cpp = { standard = "c++17", checker = "clang-tidy", checks = ["hicpp-*", "modernize-*"] }

# ============================================================================
# VERIFICATION LAYERS (Swiss Cheese Slices)
# Each layer catches different classes of defects
# ============================================================================

[layers.requirements]
name = "Requirements Formalization"
description = "Formalize requirements with Rust-specific constraints"
order = 1
gate = "gates/requirements_gate.sh"
reports = ["json", "html"]

[layers.architecture]
name = "Architecture Design"
description = "Design type-safe, ownership-correct architecture"
order = 2
depends_on = ["requirements"]
gate = "gates/architecture_gate.sh"
reports = ["json"]

[layers.tdd]
name = "Test-Driven Development"
description = "Write comprehensive tests BEFORE implementation"
order = 3
depends_on = ["architecture"]
gate = "gates/tdd_gate.sh"
reports = ["json", "xml"]  # XML for CI integration

[layers.implementation]
name = "Implementation"
description = "Implement safe Rust code to pass tests"
order = 4
depends_on = ["tdd"]
gate = "gates/implementation_gate.sh"
reports = ["json"]

[layers.static_analysis]
name = "Static Analysis"
description = "Run Clippy, cargo-audit, cargo-deny, unsafe audit"
order = 5
depends_on = ["implementation"]
gate = "gates/static_analysis_gate.sh"
reports = ["json", "html"]

[layers.formal_verification]
name = "Formal Verification"
description = "Prove properties with Kani, Prusti, Creusot"
order = 6
depends_on = ["static_analysis"]
gate = "gates/formal_verification_gate.sh"
reports = ["json"]
optional = true  # May be skipped with justification

[layers.dynamic_analysis]
name = "Dynamic Analysis"
description = "Run Miri, fuzzing, coverage, timing analysis"
order = 7
depends_on = ["implementation"]  # Can run parallel to formal verification
gate = "gates/dynamic_analysis_gate.sh"
reports = ["json", "html"]

[layers.review]
name = "Independent Review"
description = "Fresh-eyes review by independent agent"
order = 8
depends_on = ["static_analysis", "dynamic_analysis"]
gate = "gates/review_gate.sh"
reports = ["json", "html"]

[layers.safety]
name = "Safety Case Assembly"
description = "Assemble safety case and make release decision"
order = 9
depends_on = ["review", "formal_verification"]
gate = "gates/safety_gate.sh"
reports = ["json", "html"]

# ============================================================================
# COMPONENT TASKS
# Fine-grained tasks within layers, with explicit dependencies
# ============================================================================

[tasks.parse_requirements]
layer = "requirements"
description = "Parse and validate requirement specifications"
depends_on = []
agent = "requirements-agent"

[tasks.formalize_constraints]
layer = "requirements"
description = "Formalize Rust-specific type and ownership constraints"
depends_on = ["parse_requirements"]
agent = "requirements-agent"

[tasks.design_modules]
layer = "architecture"
description = "Design module structure with clear ownership boundaries"
depends_on = ["formalize_constraints"]
agent = "architecture-agent"

[tasks.define_interfaces]
layer = "architecture"
description = "Define public interfaces and trait contracts"
depends_on = ["design_modules"]
agent = "architecture-agent"

[tasks.write_unit_tests]
layer = "tdd"
description = "Write unit tests for all public interfaces"
depends_on = ["define_interfaces"]
agent = "tdd-agent"

[tasks.write_integration_tests]
layer = "tdd"
description = "Write integration tests for module interactions"
depends_on = ["write_unit_tests"]
agent = "tdd-agent"

[tasks.write_property_tests]
layer = "tdd"
description = "Write property-based tests with proptest/quickcheck"
depends_on = ["define_interfaces"]
agent = "tdd-agent"

[tasks.implement_core]
layer = "implementation"
description = "Implement core functionality to pass tests"
depends_on = ["write_unit_tests", "write_property_tests"]
agent = "implementation-agent"

[tasks.implement_integrations]
layer = "implementation"
description = "Implement integration points"
depends_on = ["implement_core", "write_integration_tests"]
agent = "implementation-agent"

[tasks.run_clippy]
layer = "static_analysis"
description = "Run clippy with all warnings as errors"
depends_on = ["implement_integrations"]
agent = "static-analysis-agent"
command = "cargo clippy --all-targets --all-features -- -D warnings"

[tasks.run_cargo_audit]
layer = "static_analysis"
description = "Audit dependencies for security vulnerabilities"
depends_on = ["implement_integrations"]
agent = "static-analysis-agent"
command = "cargo audit"

[tasks.run_cargo_deny]
layer = "static_analysis"
description = "Check dependency licenses and advisories"
depends_on = ["implement_integrations"]
agent = "static-analysis-agent"
command = "cargo deny check"

[tasks.audit_unsafe]
layer = "static_analysis"
description = "Audit all unsafe blocks with justification"
depends_on = ["implement_integrations"]
agent = "static-analysis-agent"
command = "cargo geiger --all-features"

[tasks.run_miri]
layer = "dynamic_analysis"
description = "Run Miri for undefined behavior detection"
depends_on = ["implement_integrations"]
agent = "dynamic-analysis-agent"
command = "cargo +nightly miri test"

[tasks.run_fuzzing]
layer = "dynamic_analysis"
description = "Run cargo-fuzz on critical interfaces"
depends_on = ["implement_integrations"]
agent = "dynamic-analysis-agent"

[tasks.measure_coverage]
layer = "dynamic_analysis"
description = "Measure test coverage with cargo-llvm-cov"
depends_on = ["implement_integrations"]
agent = "dynamic-analysis-agent"
command = "cargo llvm-cov --all-features --html"

[tasks.run_kani]
layer = "formal_verification"
description = "Run Kani model checker on critical functions"
depends_on = ["run_clippy"]
agent = "formal-verification-agent"
command = "cargo kani"
optional = true

[tasks.independent_review]
layer = "review"
description = "Fresh-eyes code review by independent agent"
depends_on = ["run_clippy", "run_cargo_audit", "measure_coverage"]
agent = "review-agent"

[tasks.assemble_safety_case]
layer = "safety"
description = "Compile all verification evidence into safety case"
depends_on = ["independent_review", "run_kani"]
agent = "safety-agent"

# ============================================================================
# GATE CONFIGURATIONS
# Command-line verification with return codes
# ============================================================================

[gates]
# All gates must return 0 for success, non-zero for failure
# Gates can produce reports in json, xml, html formats

[gates.static_analysis]
commands = [
    { name = "clippy", cmd = "cargo clippy --all-targets -- -D warnings --message-format=json", output = "json" },
    { name = "audit", cmd = "cargo audit --json", output = "json" },
    { name = "deny", cmd = "cargo deny check --format json", output = "json" },
]
fail_fast = true  # Stop on first failure

[gates.tdd]
commands = [
    { name = "tests", cmd = "cargo test --no-fail-fast -- --format json -Z unstable-options", output = "json" },
]
min_coverage = 80  # Minimum test coverage percentage

[gates.dynamic_analysis]
commands = [
    { name = "miri", cmd = "cargo +nightly miri test 2>&1", output = "text" },
    { name = "coverage", cmd = "cargo llvm-cov --json --output-path coverage.json", output = "json" },
]

# ============================================================================
# WORKTREE CONFIGURATION
# Git worktree settings for concurrent subagent execution
# ============================================================================

[worktree]
base_path = ".worktrees"
branch_prefix = "swiss-cheese"
cleanup_on_success = true
rebase_strategy = "linear"  # linear or merge

# ============================================================================
# AGENT CONFIGURATION
# Subagent definitions for each verification role
# ============================================================================

[agents.requirements-agent]
description = "Formalizes requirements with Rust-specific constraints"
model = "sonnet"
tools = ["Read", "Write", "Grep", "Glob"]

[agents.architecture-agent]
description = "Designs type-safe, ownership-correct architecture"
model = "sonnet"
tools = ["Read", "Write", "Grep", "Glob", "WebSearch"]

[agents.tdd-agent]
description = "Writes comprehensive tests BEFORE implementation"
model = "sonnet"
tools = ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]

[agents.implementation-agent]
description = "Implements safe Rust code to pass tests"
model = "sonnet"
tools = ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]

[agents.static-analysis-agent]
description = "Runs Clippy, cargo-audit, cargo-deny, unsafe audit"
model = "haiku"  # Faster model for automated checks
tools = ["Read", "Bash", "Grep", "Glob"]

[agents.dynamic-analysis-agent]
description = "Runs Miri, fuzzing, coverage, timing analysis"
model = "haiku"
tools = ["Read", "Bash", "Grep", "Glob"]

[agents.formal-verification-agent]
description = "Proves properties with Kani, Prusti, Creusot"
model = "sonnet"
tools = ["Read", "Write", "Bash", "Grep", "Glob"]

[agents.review-agent]
description = "Independent fresh-eyes review"
model = "opus"  # Most capable model for thorough review
tools = ["Read", "Grep", "Glob", "WebSearch"]

[agents.safety-agent]
description = "Assembles safety case and makes release decision"
model = "opus"
tools = ["Read", "Write", "Grep", "Glob"]
